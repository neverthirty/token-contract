
"TonUtil.fif" include
"Asm.fif" include

// $ -- id
{ $>B crc16 0xffff and 0x10000 or } : method_id

{ rot = -rot = and } : 2=
{ 2= not } : 2<>

// s -- wc addr s'
{ 1 i@+ swap not abort"Internal address expected"
  1 i@+
  1 i@+ swap { 4 u@+ swap u@+ nip } if
  swap { 9 u@+ 32 } { 256 swap 8 } cond
  i@+ rot u@+
} : addr@+
{ addr@+ drop } : addr@

// s len -- res s'
{ tuck u@+ -rot swap
  <b -rot u, b> <s swap
} : s@+ // TODO: support for more than 256 bits or rather add C++ code for it
{ s@+ drop } : s@

// s -- addr s'
{ 1 i@+ swap abort"External address expected"
  1 i@+ swap
  { 9 u@+ swap s@+ }
  { x{} swap } cond
} : ext-addr@+
{ ext-addr@+ drop } : ext-addr@

// s --
{
  1 i@+ swap { ."not an internal message" cr 0 halt } if
  1 i@+ swap =: msg.ihr-disabled
  1 i@+ swap =: msg.bounce
  1 i@+ nip
  2 u@+ swap 0 <> { ."src = none expected" cr 0 halt } if
  addr@+ -rot 2=: msg.dest
  Gram@+ swap =: msg.value
  1 i@+ swap { ref@+ swap } { null } cond =: msg.extra
  Gram@+ nip Gram@+ nip
  64 u@+ nip 32 u@+ nip
  1 i@+ swap { ref@+ } { null } cond =: msg.stateInit
  1 i@+ swap { ref@ } { s>c } cond =: msg.body
} : parse-int-msg

// s --
{
  2 u@+ swap 3 <> { ."not an outbound external message" cr 0 halt } if
  2 u@+ swap 0 <> { ."src = none expected" cr 0 halt } if
  ext-addr@+ swap =: msg.dest
  64 u@+ nip 32 u@+ nip
  1 i@+ swap { ref@+ } { null } cond =: msg.stateInit
  1 i@+ swap { ref@ } { s>c } cond =: msg.body
 } : parse-ext-msg

// s --
{
  dup 1 i@
  { `ext =: msg.type parse-ext-msg }
  { `int =: msg.type parse-int-msg } cond
} : parse-msg

"compiled.fif" include <s constant code

<b
"0:448bcf827469c5fc38541c77fdd91d4e347eac200f6f2d9fd62dc08885f0415f" parse-smc-addr drop Addr,
0 64 u,
<b
<b
1 8 u,
"https://ton.org/collection.json" $,
b> ref,
<b
"https://ton.org/meta/" $,
b> ref,
b> ref,
B{B5EE9C7241022B0100069E000114FF00F4A413F4BCF2C80B0102016202030202CC0405020120212202012006070201481B1C0201200809020158191A0201200A0B000D470C8CB01C9D0803F73E09DBC400B434C0C05C6C2497C1383E903E900C7E800C5C75C87E800C7E800C3C0289ECF8C094D671C1462C238D0426D7C2FE900C1C083E095B60101C20043232C15401F3C594017E808572DA84B2C7F2CFC89BACE51633C5C0644CB88072407EC0380A71C0245C254274C7D42AB8887C023E08C86F09300038C0A00C0D0E00113E910C1C2EBCB8536000C65F056C22345232C705F2E19501FA40D4D200306D70C8CB07F400C9F823821062E4F310A18208278D00A90420C20C9330800CDE8208093A808208092C7058A8800CA904A1F82301A022912492F002E203943033356D964470F0091025E21035F823F00B013C343A3A3B8E1636363737375135C705F2E196102510241023F823F00BE30E0F01FC310DD33F256EB31FB08E69343653CDA182103B9ACA005210A15270BC993682103B9ACA0016A1923005E220C2008E378210370FEC516D72295134544743708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB001CA10B9130E26D5477655477632EF00B02926C21E282105FCC3D141101FC302680698064A98452B0BEF2E19782103B9ACA0052A0A15270BC993682103B9ACA0019A193390805E220C2008E328210557CEA20F82510396D71708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB00923036E2810E1023F823A1A120C2009313A0029130E24474F0091024F823100004F00B04C05220BA8E9731373B5372C705F2E191109A104910384706401504DB3CE082101A0B9D515220BA8E195B32353537375135C705F2E19A03D4304015045033F823F00BE02182104EB1F0F9BAE3023B20821044BEAE41BAE302382782104ED14B65BA1512131400885B363638385147C705F2E19B04D3FF20D74AC20007D0D30701C000F2E19CF404300798D43040168307F417983050058307F45B30E270C8CB07F400C910354014F823F00B029C30363A246EF2E19D8051F833D0F4043052408307F40E6FA1F2E19FD30721C00022C001B1F2E1A021C0008E9324109B1068517A10571046105C43144CDDDB3C9630103A395F07E201C001915BE30D151601A2E3025F0432353582102FCB26A2BA8E3A7082108B77173504C8CBFF5005CF161443308040708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB00E05F04840FF2F01801F03502FA4021F001FA40D20031FA0082103B9ACA001DA121945314A0A1DE22D70B01C300209205A19135E220C2FFF2E192218E3E821005138D91C8500BCF16500DCF1671244B145448C0708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB00106994102C395BE201170064708210370FEC51586D8100A0708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB00008A8E3528F0018210D53276DB103946096D71708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB0093383430E21045103412F823F00B00FC37F8235006A18209E28500BC066E16B0F2E19E23D0D749F823F0075290BEF2E1975178A182103B9ACA00A120C2008E32102782104ED14B6558076D72708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB0093303535E2F8238208093A80A0F0024477F0091045103412F823F00B005708300065CC2042EDE0404AF8083000A58C2040F9E018F8083000E58C20403E600678300124E00C5D781E9C600069006AC0BC018060840EE6B2802A0060840EE6B2802A00A08418B93CC428608209E3402A410830856456F81B04A5A9D6A0192A4139200201201D1E0201201F200021081BA50C1B5C0838343E903E8034CFCC200017321400F3C5807E80B2CFF26000513B513434FFFE900835D2708027DFC07E9035353D0134CFCC0415C415B80C1C1B5B5B5B490415C415A0002B01B232FFD40173C59400F3C5B3333D0032CFF27B5520020120232402012027280013BBB39F00A175F07F008802027425260010A874F00A10475F07000CA959F00A6C71000DB8FCFF00A5F038020120292A0013B64A5E014204EBE0FA1000C7B461843AE9240F152118001E5C08DE014206EBE0FA1A60E038001E5C339E8086007AE140F8001E5C33B84111C466105E033E04883DCB11FB64DDC4964AD1BA06B879240DC23572F37CC5CAAAB143A2FFFBC4180012660F003C003060FE81EDF4260F00303ECB4335} B>boc ref,
<b
0 16 u,
0 16 u,
0 2 u,
b> ref,
<b
3500 16 u,
1000 16 u,
375 16 u,
100 16 u,
25 16 u,
200 16 u,
100 16 u,
100 16 u,
100 16 u,
100 16 u,
0 16 u,
0 16 u,
0 16 u,
0 16 u,
0 16 u,
b> ref,
b> constant storage

dictnew
 constant global_config

<b <b b{00110} s, <b code s, b> ref, storage ref, b>
hashu -1 swap addr, b> <s constant contract_address


"0:448bcf827469c5fc38541c77fdd91d4e347eac200f6f2d9fd62dc08885f0415f" // sender address
parse-smc-addr drop 2constant sender_address0

10000000000 constant msg_value0 // in_msg amount

<b
5 32 u,
0 64 u,
<b
200 16 u,
100 16 u,
100 16 u,
100 16 u,
100 16 u,
b> ref,
b> constant in_msg_body0

<b b{0110} s, // flags
   sender_address0 Addr, // sender address
   sender_address0 Addr, // dest address
   0 Gram,  // value
   0 1 u, // extra currency dict
   0 Gram, // ihr_fee
   0 Gram, // fwd_fee
b> constant in_msg0

0x076ef1ea           // magic
0                    // actions
0                    // msgs_sent
1628090356           // unixtime
1                    // block_lt
999                    // trans_lt
239                  // randseed
1000000000 null pair // balance_remaining
contract_address     // myself
global_config        // global_config
10 tuple 1 tuple constant c7

msg_value0 in_msg0 in_msg_body0 <s 0 code storage c7 0x75 runvmx
// returns ...values exit_code new_c4 c5
swap rot

dup { ."Error: non-zero exit code (" . .")" cr 0 halt } { drop } cond


<b
"0:448bcf827469c5fc38541c77fdd91d4e347eac200f6f2d9fd62dc08885f0415f" parse-smc-addr drop Addr,
0 64 u,
<b
<b
1 8 u,
"https://ton.org/collection.json" $,
b> ref,
<b
"https://ton.org/meta/" $,
b> ref,
b> ref,
B{B5EE9C7241022B0100069E000114FF00F4A413F4BCF2C80B0102016202030202CC0405020120212202012006070201481B1C0201200809020158191A0201200A0B000D470C8CB01C9D0803F73E09DBC400B434C0C05C6C2497C1383E903E900C7E800C5C75C87E800C7E800C3C0289ECF8C094D671C1462C238D0426D7C2FE900C1C083E095B60101C20043232C15401F3C594017E808572DA84B2C7F2CFC89BACE51633C5C0644CB88072407EC0380A71C0245C254274C7D42AB8887C023E08C86F09300038C0A00C0D0E00113E910C1C2EBCB8536000C65F056C22345232C705F2E19501FA40D4D200306D70C8CB07F400C9F823821062E4F310A18208278D00A90420C20C9330800CDE8208093A808208092C7058A8800CA904A1F82301A022912492F002E203943033356D964470F0091025E21035F823F00B013C343A3A3B8E1636363737375135C705F2E196102510241023F823F00BE30E0F01FC310DD33F256EB31FB08E69343653CDA182103B9ACA005210A15270BC993682103B9ACA0016A1923005E220C2008E378210370FEC516D72295134544743708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB001CA10B9130E26D5477655477632EF00B02926C21E282105FCC3D141101FC302680698064A98452B0BEF2E19782103B9ACA0052A0A15270BC993682103B9ACA0019A193390805E220C2008E328210557CEA20F82510396D71708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB00923036E2810E1023F823A1A120C2009313A0029130E24474F0091024F823100004F00B04C05220BA8E9731373B5372C705F2E191109A104910384706401504DB3CE082101A0B9D515220BA8E195B32353537375135C705F2E19A03D4304015045033F823F00BE02182104EB1F0F9BAE3023B20821044BEAE41BAE302382782104ED14B65BA1512131400885B363638385147C705F2E19B04D3FF20D74AC20007D0D30701C000F2E19CF404300798D43040168307F417983050058307F45B30E270C8CB07F400C910354014F823F00B029C30363A246EF2E19D8051F833D0F4043052408307F40E6FA1F2E19FD30721C00022C001B1F2E1A021C0008E9324109B1068517A10571046105C43144CDDDB3C9630103A395F07E201C001915BE30D151601A2E3025F0432353582102FCB26A2BA8E3A7082108B77173504C8CBFF5005CF161443308040708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB00E05F04840FF2F01801F03502FA4021F001FA40D20031FA0082103B9ACA001DA121945314A0A1DE22D70B01C300209205A19135E220C2FFF2E192218E3E821005138D91C8500BCF16500DCF1671244B145448C0708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB00106994102C395BE201170064708210370FEC51586D8100A0708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB00008A8E3528F0018210D53276DB103946096D71708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB0093383430E21045103412F823F00B00FC37F8235006A18209E28500BC066E16B0F2E19E23D0D749F823F0075290BEF2E1975178A182103B9ACA00A120C2008E32102782104ED14B6558076D72708010C8CB055007CF165005FA0215CB6A12CB1FCB3F226EB39458CF17019132E201C901FB0093303535E2F8238208093A80A0F0024477F0091045103412F823F00B005708300065CC2042EDE0404AF8083000A58C2040F9E018F8083000E58C20403E600678300124E00C5D781E9C600069006AC0BC018060840EE6B2802A0060840EE6B2802A00A08418B93CC428608209E3402A410830856456F81B04A5A9D6A0192A4139200201201D1E0201201F200021081BA50C1B5C0838343E903E8034CFCC200017321400F3C5807E80B2CFF26000513B513434FFFE900835D2708027DFC07E9035353D0134CFCC0415C415B80C1C1B5B5B5B490415C415A0002B01B232FFD40173C59400F3C5B3333D0032CFF27B5520020120232402012027280013BBB39F00A175F07F008802027425260010A874F00A10475F07000CA959F00A6C71000DB8FCFF00A5F038020120292A0013B64A5E014204EBE0FA1000C7B461843AE9240F152118001E5C08DE014206EBE0FA1A60E038001E5C339E8086007AE140F8001E5C33B84111C466105E033E04883DCB11FB64DDC4964AD1BA06B879240DC23572F37CC5CAAAB143A2FFFBC4180012660F003C003060FE81EDF4260F00303ECB4335} B>boc ref,
<b
0 16 u,
0 16 u,
0 2 u,
b> ref,
<b
3500 16 u,
1000 16 u,
375 16 u,
100 16 u,
25 16 u,
200 16 u,
100 16 u,
100 16 u,
100 16 u,
100 16 u,
0 16 u,
0 16 u,
0 16 u,
0 16 u,
0 16 u,
b> ref,
b> constant correct_new_storage
hashu correct_new_storage hashu <> { ."Error: incorrect resulting storage" cr 0 halt } if



<s dup 0 swap { dup empty? not } {
  ref@ <s swap 1+ swap
} while drop
0 <> { ."Error: incorrect number of actions" cr 0 halt } if


drop
    



0 <b
"test" $,
b>
"get_nft_content" method_id code storage c7 0x15 runvmx drop
dup { ."Error: non-zero exit code (" . .")" cr 0 halt } { drop } cond

depth 1 <>
{ ."Error: incorrect output length of get_nft_content; output: " .s cr 0 halt } if
 hashu <b
1 8 u,
"https://ton.org/meta/0000.json" $,
b> hashu = not { ."Error: incorrect output value" cr 0 halt } if


254 <b
b>
"get_nft_content" method_id code storage c7 0x15 runvmx drop
dup { ."Error: non-zero exit code (" . .")" cr 0 halt } { drop } cond

depth 1 <>
{ ."Error: incorrect output length of get_nft_content; output: " .s cr 0 halt } if
 hashu <b
1 8 u,
"https://ton.org/meta/00FE.json" $,
b> hashu = not { ."Error: incorrect output value" cr 0 halt } if


0
"get_nft_type_sales_info" method_id code storage c7 0x15 runvmx drop
dup { ."Error: non-zero exit code (" . .")" cr 0 halt } { drop } cond

depth 4 <>
{ ."Error: incorrect output length of get_nft_type_sales_info; output: " .s cr 0 halt } if
0 = not { ."Error: incorrect output value" cr 0 halt } if
200 = not { ."Error: incorrect output value" cr 0 halt } if
3500 = not { ."Error: incorrect output value" cr 0 halt } if
1500 = not { ."Error: incorrect output value" cr 0 halt } if


1
"get_nft_type_sales_info" method_id code storage c7 0x15 runvmx drop
dup { ."Error: non-zero exit code (" . .")" cr 0 halt } { drop } cond

depth 4 <>
{ ."Error: incorrect output length of get_nft_type_sales_info; output: " .s cr 0 halt } if
0 = not { ."Error: incorrect output value" cr 0 halt } if
100 = not { ."Error: incorrect output value" cr 0 halt } if
1000 = not { ."Error: incorrect output value" cr 0 halt } if
500 = not { ."Error: incorrect output value" cr 0 halt } if


2
"get_nft_type_sales_info" method_id code storage c7 0x15 runvmx drop
dup { ."Error: non-zero exit code (" . .")" cr 0 halt } { drop } cond

depth 4 <>
{ ."Error: incorrect output length of get_nft_type_sales_info; output: " .s cr 0 halt } if
0 = not { ."Error: incorrect output value" cr 0 halt } if
100 = not { ."Error: incorrect output value" cr 0 halt } if
375 = not { ."Error: incorrect output value" cr 0 halt } if
125 = not { ."Error: incorrect output value" cr 0 halt } if


3
"get_nft_type_sales_info" method_id code storage c7 0x15 runvmx drop
dup { ."Error: non-zero exit code (" . .")" cr 0 halt } { drop } cond

depth 4 <>
{ ."Error: incorrect output length of get_nft_type_sales_info; output: " .s cr 0 halt } if
0 = not { ."Error: incorrect output value" cr 0 halt } if
100 = not { ."Error: incorrect output value" cr 0 halt } if
100 = not { ."Error: incorrect output value" cr 0 halt } if
25 = not { ."Error: incorrect output value" cr 0 halt } if


4
"get_nft_type_sales_info" method_id code storage c7 0x15 runvmx drop
dup { ."Error: non-zero exit code (" . .")" cr 0 halt } { drop } cond

depth 4 <>
{ ."Error: incorrect output length of get_nft_type_sales_info; output: " .s cr 0 halt } if
0 = not { ."Error: incorrect output value" cr 0 halt } if
100 = not { ."Error: incorrect output value" cr 0 halt } if
25 = not { ."Error: incorrect output value" cr 0 halt } if
0 = not { ."Error: incorrect output value" cr 0 halt } if



."All tests passed" cr
